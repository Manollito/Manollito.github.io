---
title: "Visualización de información sobre el covid"
---

**Autores:** Manuel de Jesús Calero Ríos y Harlen Daniel Quirós Gómez

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library (ggplot2)
library(dplyr)
library(readxl)
library(plotly)
library(tidyr)
library(lubridate)
library(gghighlight)
library(patchwork)

covid <- read_excel("CasosCOVID.xlsx", sheet = "1_GENERAL")
covid_provincias <- read_excel("CasosCOVID.xlsx", sheet = "2_4 CANT_ACTIVOS")
covid2 <- read_excel("CasosCOVID.xlsx", sheet = "2_5 CANT_NUEVOS")
covidRecuperados <- read_excel("CasosCOVID.xlsx", sheet = "2_2 CANT_RECUPERADOS")
covidFallecidos <- read_excel("CasosCOVID.xlsx", sheet = "2_3 CANT_FALLECIDOS")
covid_provincias <- covid_provincias %>%
  pivot_longer(names_to='fecha',
               cols = starts_with("4")) %>%
  mutate(fecha = as.Date(as.numeric(fecha), origin = "1900-01-01" )) %>%
  group_by(provincia, fecha) %>%
  summarise(casos = sum(value)) %>%
  mutate(anio = year(fecha)) %>%
  filter( provincia != 'Otros')
covid2 <- covid2 %>%
  pivot_longer(names_to='fecha',
               cols = starts_with("4")) %>%
  mutate(fecha = as.Date(as.numeric(fecha), origin = "1900-01-01" )) %>%
  group_by(provincia, fecha) %>%
  summarise(casos = sum(value)) %>%
  mutate(anio = year(fecha)) %>%
  filter( provincia != 'Otros')
covidRecuperados <- covidRecuperados %>%
  pivot_longer(names_to='fecha',
               cols = starts_with("4")) %>%
  mutate(fecha = as.Date(as.numeric(fecha), origin = "1900-01-01" )) %>%
  group_by(provincia, fecha) %>%
  summarise(casos = sum(value)) %>%
  mutate(anio = year(fecha)) %>%
  filter( provincia != 'Otros', anio == 2021)
covidFallecidos <- covidFallecidos %>%
  pivot_longer(names_to='fecha',
               cols = starts_with("4")) %>%
  mutate(fecha = as.Date(as.numeric(fecha), origin = "1900-01-01" )) %>%
  group_by(provincia, fecha) %>%
  summarise(casos = sum(value)) %>%
  mutate(anio = year(fecha)) %>%
  filter( provincia != 'Otros', anio == 2021)
```
# Gráficas unidimensionales 
```{r}
covid_no_acumulado <- covid %>%
  mutate(
    anterior_dia_hombre = lag(hom_posi),
    anterior_dia_mujer = lag(muj_posi),
    muj_posi_no_acumulado = muj_posi - anterior_dia_mujer,
    homb_posi_no_acumulado = hom_posi - anterior_dia_hombre,    
  ) %>%
  select(FECHA, muj_posi, anterior_dia_mujer, muj_posi_no_acumulado, hom_posi, anterior_dia_hombre, homb_posi_no_acumulado, everything())
```

```{r}
p <- ggplot(covid, aes(nue_posi)) + geom_histogram(binwidth=100 , fill = "red")+ 
  labs(
    x = "Cantidad de casos de covid", 
    y = "Cantidad de dias", 
    title = "Casos nuevos covid") +
  scale_x_continuous(breaks=seq( 0, max(covid$nue_posi), by=500) ) +
  theme_classic()
ggplotly(p)
```
En las gráfica anterior se puede observar que la mayoría de días hubo muy pocos casos activos nuevos, y el dia que hubo aproximadamente 7000 casos fue solo uno. Esto da como indicio que el covid se fue esparciendo poco a poco y que muy pocos días hubo picos altos de contagio, causando así que el virus se mantuviera controlado.

```{r}
p <- ggplot(covid_no_acumulado, aes(muj_posi_no_acumulado)) + geom_histogram(binwidth=100, fill = "#F33A6A")+ 
  labs(
    x = "Cantidad casos de covid: Mujeres", 
    y = "Cantidad de dias", 
    title = "Casos nuevos de covid en mujeres") +
  scale_x_continuous(breaks=seq( 0, max(covid$nue_posi), by=500) ) +
  theme_classic()
ggplotly(p)
```
En la gráfica anterior se observa de igual manera que hubo muchos días donde hubo nuevos contagios de mujeres con covid, sí hubo picos de casos, pero fueron muy pocos días, por lo que el covid en los hombres no se vio muy disparado y siempre fue creciendo de manera uniforme.

```{r}
p <- ggplot(covid_no_acumulado, aes(homb_posi_no_acumulado)) + geom_histogram(binwidth=100, fill = "blue")+ 
  labs(
    x = "Cantidad casos de covid: Hombres", 
    y = "Cantidad de dias", 
    title = "Casos nuevos de covid en hombres") +
  scale_x_continuous(breaks=seq( 0, max(covid$nue_posi), by=500) ) +
  theme_classic()
ggplotly(p)
```
En la gráfica anterior se observa de igual manera que hubo muchos días donde hubo nuevos contagios de mujeres con covid, sí hubo picos de casos, pero fueron muy pocos días, por lo que el covid en los hombres no se vio muy disparado y siempre fue creciendo de manera uniforme. En comparación con las mujeres, estas tienen el pico más alto de nuevos contagios de covid, con casi 4000, mientras el dia en pico más alto de hombres fue de casi 3400.

# Gráficas bidimensionales


```{r}
covid_edad <- covid %>%
  mutate(
    ant_dia_adul = lag(adul_posi),
    ant_dia_am = lag(am_posi),
    ant_dia_menor = lag(menor_posi),
    `Adultos fallecidos` = adul_posi - ant_dia_adul,
    `Adultos mayores fallecidos`  = am_posi - ant_dia_am,
    `Menores fallecidos`  = menor_posi - ant_dia_menor
  ) %>%
  select(`Menores fallecidos`, `Adultos fallecidos`, `Adultos mayores fallecidos`, FECHA) %>%
  pivot_longer(names_to='edad',
               cols = c('Menores fallecidos',  'Adultos fallecidos',	'Adultos mayores fallecidos')
) %>%
  filter(!is.na(value))

```

```{r}
p <- ggplot(covid_edad, aes(edad, value)) + geom_violin(fill = "green") + 
  labs(
    x = "Categoria de edad", 
    y = "Cantidad de casos", 
    title = "Cantidad de casos fallecidos por categoría de edad"
  ) +
  scale_y_continuous(breaks=seq( 0, max(covid_edad$value), by=500) ) +
  theme_classic()
ggplotly(p)
```
Hubo muchos dias con pocas muertes en niños y adultos mayores, pero los adultos tuvieron días con muchos más muertes, aunque estos fueron pocos, por eso la gráfica se ve tan punteada. En los adultos hubo más dias con pocos muertos, por eso se ve tan ancha en la base, en los niños si hubo días con más muertos, aunque esto se ve uniforme.

```{r}
covid_muertos <- covid %>%
  mutate(
    ant_dia_hom_fall = lag(hom_fall),
    ant_dia_muj_fall = lag(muj_fall),
    `hombres fallecidos` = hom_fall - ant_dia_hom_fall,
    `mujeres fallecidas` = muj_fall - ant_dia_muj_fall
  ) %>%
  select(`hombres fallecidos`, `mujeres fallecidas`, FECHA) %>%
  pivot_longer(names_to='fallecidos',
               cols = c('hombres fallecidos',  'mujeres fallecidas')
) %>%
  filter(!is.na(value), value>=0)
```

```{r}
p <- ggplot(covid_muertos, aes(fallecidos, value)) + geom_boxplot() + 
  labs(
    x = "Sexo de los fallecidos", 
    y = "Cantidad de fallecidos", 
    title = "Cantidad de fallecidos por sexo"
  ) +
  scale_y_continuous(breaks=seq( 0, max(covid_edad$value), by=500) ) +
  theme_classic()
ggplotly(p)
```

- En ambos gráficos se puede ver que hay días donde levemente hubo más hombres fallecidos que mujeres. Hubieron días que no hubo muertes. La caja de los hombres se observa un poco más larga, lo que quiere decir que la dispersión de cantidad de fallecidos por día es mayor en los hombres.

```{r}
p <- ggplot(covid_provincias, aes(fecha, casos, color = as.factor(anio))) + 
  geom_line() + 
  labs(
    x = ""
  )+
  facet_grid(provincia ~ anio, scales = "free_x")+
  theme_minimal() +
  scale_color_manual(values = c("2020" = "red", "2021" = "blue", "2022" = "green"))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
ggplotly(p)
```

En la gráfica anterior se observa como la provincia con mayor cntidad de picos es San José, especialmente en el año 2022, que es el año donde se ve más pronunciado. Limón, Puntarenas y Guanacaste son las provincias con la menor cantidad de casos, estos no tuvieron picos y la propagación fue muy uniforme.El comportamiento de Alajuela es más pronunciado en el 2021 y 2022, por lo que al principio de la pandemia hubo menos casos y conforme fue avanzando se dieron más. Cartago y Heredia son provincias donde este compórtamiento estuvo muy parecido, tienen picos, pero no muy extensos, y se ve muy uniforme la propagación. Las provincias costeras se dieron menos casos, pero en GAM hubo más, por lo que se puede dar una relación bastante curiosa.

```{r}

```

# Gráfica multidimensional

```{r}
covid_2021 <- covid2 %>%
  filter(anio == 2021)

covid_top5 <- covid_2021 %>%
  filter(provincia %in% (covid_2021 %>%
  group_by(provincia) %>%
  summarise(total_casos = sum(casos)) %>%
  arrange(desc(total_casos))%>%
  slice(1:5))$provincia)

p <- ggplot(covid_top5, aes(fecha, casos, color = provincia)) +
  geom_point() +
  gghighlight(max(casos)) +
  facet_wrap(vars(provincia)) +
  labs(title = "Top 5 Provincias con más casos de COVID-19 activo en 2021",
       x = "Fecha",
       y = "Casos",
       color = "Provincia") +
  theme_minimal()
ggplotly(p)
```

- En este caso para mostrar la gráfica multidimensional se utilizó la técnica de puntos, pero con el detalle de separar los casos en colores combinando con tonos grises para así poder distinguir los datos. Gracias a ello se comprueba que San José y Alajuela tuvieron la mayor cantidad de casos activos durante el año 2021, además que provincias como Cartago, Hereria y Puntarenas tuvieron un ritmo bajo de casos activos, sin decir que tuvieron el mismo.

# Gráfica compuesta

```{r}
p_recuperados <- ggplot(covidRecuperados, aes(fecha, casos, fill = provincia)) +
  geom_bar(stat = "identity") +  
  facet_wrap(vars(provincia)) +
  labs(title = "Recuperados por provincia en 2021",
       x = "Fecha",
       y = "Recuperados",
       fill = "Provincia")


p_fallecidos <- ggplot(covidFallecidos, aes(fecha, casos, color = provincia)) +
  geom_point() +
  facet_wrap(vars(provincia)) +
  labs(title = "Fallecidos por provincia en 2021",
       x = "Fecha",
       y = "Fallecidos",
       color = "Provincia")
p_recuperados + p_fallecidos

```

- En dicha gráfica compuesta se observa que tanto los pacientes recuperados como los fallecidos poseen un mismo patrón, en todas las provincias, si bien sus números de casos son distintos, manejan semejanzas en sus comportamientos.
